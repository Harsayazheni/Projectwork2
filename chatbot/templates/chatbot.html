{% extends "base.html" %}

{% block content %}

<style>
    .chat-container {
        max-width: 900px;
        margin: 20px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        height: 600px;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px 12px 0 0;
        text-align: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message-content {
        max-width: 70%;
        padding: 14px 18px;
        border-radius: 18px;
        line-height: 1.6;
        white-space: normal;
    }

    .message.user .message-content {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 6px;
    }

    .message.bot .message-content {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 6px;
    }

    .quick-questions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 10px 20px;
    }

    .quick-q-btn {
        padding: 8px 14px;
        border-radius: 18px;
        border: 1px solid #ddd;
        background: #f3f4f6;
        font-size: 13px;
        cursor: pointer;
    }

    .quick-q-btn:hover {
        background: #667eea;
        color: white;
    }

    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #e0e0e0;
        background: white;
        border-radius: 0 0 12px 12px;
    }

    .input-wrapper {
        display: flex;
        gap: 10px;
    }

    #user-input {
        flex: 1;
        padding: 12px 16px;
        border-radius: 24px;
        border: 2px solid #e0e0e0;
        font-size: 15px;
    }

    #send-btn {
        padding: 12px 28px;
        border-radius: 24px;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        cursor: pointer;
    }
</style>

<div class="chat-container">

    <div class="chat-header">
        <h2>ðŸ¤– OPUS Career Assistant</h2>
        <p>Ask me about your career path: {{ prediction }}</p>
    </div>

    <div class="chat-messages" id="chat-messages">
        <div class="message bot">
            <div class="message-content">
                ðŸ‘‹ Hi! Iâ€™m here to help you with your career journey as a
                <strong>{{ prediction }}</strong>.
            </div>
        </div>
    </div>

    <!-- QUICK PROMPTS -->
    <div class="quick-questions">
        <button class="quick-q-btn" onclick="sendQuick('Why was {{ prediction }} recommended for me?')">ðŸ¤” Why this career?</button>
        <button class="quick-q-btn" onclick="sendQuick('What skills should I improve first?')">ðŸ§  Skills</button>
        <button class="quick-q-btn" onclick="sendQuick('Suggest a 3-month learning plan')">ðŸ“† 3-month plan</button>
        <button class="quick-q-btn" onclick="sendQuick('What courses should I take?')">ðŸŽ“ Courses</button>
        <button class="quick-q-btn" onclick="sendQuick('How can I improve my resume?')">ðŸ“„ Resume</button>
    </div>

    <div class="chat-input-area">
        <div class="input-wrapper">
            <input id="user-input" placeholder="Ask me anything about your career...">
            <button id="send-btn">Send</button>
        </div>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

/* ðŸ”¥ THIS IS THE FIX */
function formatBotText(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // bold
        .replace(/\n\n+/g, '<br><br>')                    // paragraphs
        .replace(/\n/g, '<br>');                          // line breaks
}

function addMessage(text, isUser=false) {
    const div = document.createElement('div');
    div.className = 'message ' + (isUser ? 'user' : 'bot');

    const content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = isUser ? text : formatBotText(text);

    div.appendChild(content);
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendToBot(message) {
    const res = await fetch('/chatbot/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
    });
    const data = await res.json();
    addMessage(data.success ? data.response : data.error, false);
}

function sendMessage() {
    const msg = userInput.value.trim();
    if (!msg) return;
    addMessage(msg, true);
    userInput.value = '';
    sendToBot(msg);
}

function sendQuick(q) {
    addMessage(q, true);
    sendToBot(q);
}

sendBtn.onclick = sendMessage;
userInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});
</script>

{% endblock %}
